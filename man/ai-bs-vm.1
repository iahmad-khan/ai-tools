.TH AI-BS-VM "1" "February 2014" "ai-bs-vm" "User Commands"
.SH NAME
ai-bs-vm \- Command-line tool to create Puppetized OpenStack VMs

.SH SYNOPSIS
.B "ai-bs-vm"
[OPTION]...
\fI-g HOSTGROUP\fR
\fI-i IMAGE\fR [VMNAME]

.SH DESCRIPTION
ai-bs-vm is a Python command line tool to create Puppet-managed
Foreman-enabled OpenStack VMs.
.LP
If no VM name is specified a random hostname will be generated
based on a trimmed SHA1 hashed UNIX timestamp. The length is
limited to 60 characters (prefix included). Using a prefix is
recommended (see --prefix).
.LP
Current officially supported images are: SLC6 Server and SLC5 Server.
.LP
"SLCx CERN Server" ones \fBare not supported\fR.
.LP
.I Prerequisites:
.TP
.B OpenStack credentials
Your OpenStack credentials are in place (get an \fBopenrc.sh\fR from
OpenStack Horizon and source it). By doing this you will set the OpenStack
instance you want to use and the project for your VM. More info:
http://cern.ch/go/k9hf
.TP
.B Valid Kerberos5 ticket
The user invoking the script must have a valid (existent and not expired)
Kerberos ticket in the file pointed by the environment variable KRB5CCNAME
(should be fine if you're on aiadm).

.SH OPTIONS
The behaviour of the tool can be customized by the following
parameters. In order to keep backwards compatibility with older
versions of ai-bs-vm, some of them can also be set via environment
variables (in parenthesis):

.LP
.I Mandatory parameters:
.TP
.B -g, --foreman-hostgroup (AIBS_HOSTGROUP_NAME)
Name of the Foreman hostgroup where you want your new virtual
machine to land (beware that you must be hostgroup manager of it).
.TP
.B -i, --nova-image (AIBS_VMIMAGE_NAME)
OpenStack image name of the virtual machine (get a list from
nova image-list).
.LP
Although the synopsis indicates that -g and -i are mandatory
parameters, both will become optional if the values are passed via
the corresponding environment variables.

.LP
.I Optional parameters:
.TP
.B --config
Path to the config file (default /etc/ai/aitools.conf).
.TP
.B --foreman-environment (AIBS_ENVIRONMENT_NAME)
Name of the Foreman environment you want your new virtual
machine to join (defaults to "production").
.TP
.B --foreman-parameter
Parameter to be added to the host in Foreman (format: key=value,
example: network=23). This option can be specified several times.
.TP
.B --landb-mainuser (AIBS_LANDB_MAINUSER)
E-group name to be set as main user in LANDB. If not specified
the user creating the VM is set as main user (Grizzly and onwards
only). Foreman owner will be set accordingly later on.
.TP
.B --landb-responsible (AIBS_LANDB_RESPONSIBLE)
E-group name to be set as responsible in LANDB. If not specified
the user creating the VM is set as responsible (Grizzly and onwards
only). Foreman owner will be set accordingly later on.
.TP
.B --nova-availabilityzone (AIBS_VMAVAILZONE_NAME)
The desired availability zone for the VM (see http://cern.ch/go/7ttT).
.TP
.B --nova-flavor (AIBS_VMFLAVOR_NAME)
OpenStack flavor name of the virtual machine (defaults to "m1.small").
.TP
.B --nova-sshkey (AIBS_SSHKEY_NAME)
Name of the SSH key to login into the machine as root in case of
disaster. Use Horizon or nova keypair-add to generate a new keypair
[string]. Because of the security implications this option has, it's
strongly recommended to avoid it. Your new VM will have the Kerberos
module enabled by default, use it to configure who has root access
to the box. See http://cern.ch/go/7qW6
.TP
.B --nova-boot-from-existing-volume
Cinder Volume UUID to boot from. In order to boot from an existing volume,
it has to be bootable and available (it will fail in any other case).
This parameter is mutually exclusive with 'nova-image', only one bootable
element can be specified per VM. (see http://cern.ch/go/l9xP)
.TP
.B --prefix (AIBS_VMNAME_PREFIX)
Prefix to prepend to the randomly generated hostname (defaults to "vm").
.LP
.I Other optional parameters:
.TP
The following parameters are for advanced users and debugging.
.TP
.B --certmgr-hostname (AIBS_CASERVER_HOSTNAME)
Hostname of the Cert Manager server that the virtual machine will request a certificate from
from.
.TP
.B --certmgr-port
Port of the Cert Manager server that the virtual machine will request a certificate from
from.
.TP
.B --certmgr-timeout
Timeout (in seconds) for Cert Manager operations.
.TP
.B -d, --dryrun
Don't do the requests that alter data (Foreman registration, host staging
and VM creation request).
.TP
.B --foreman-hostname
FQDN of the Foreman instance to use.
.TP
.B --foreman-port
Port of the Foreman instance to use -- must support Kerberos.
.TP
.B --foreman-timeout
Timeout (in seconds) for Foreman operations.
.TP
.B --grow-partition
Partition of the image disk (/dev/vda) to grow (default: 2).
.TP
.B -h, --help
Display usage and exit.
.TP
.B --nogrow
Don't grow the image disk (/dev/vda) after the Puppet initialization.
.TP
.B --noreboot
Don't reboot after the Puppet initialization.
.TP
.B --nova-parameter
Parameter to be passed to Nova as metaparameter (format: key=value,
example: network=23). This option can be specified several times.
.TP
.B --nova-timeout
Timeout (in seconds) for Openstack operations.
.TP
.B --puppetmaster-hostname (AIBS_PUPPETMASTER_HOSTNAME)
Hostname of the Puppet master the virtual machine will request its
configuration from (defaults to "it-puppet-masters-public.cern.ch").
.TP
.B --puppetinit-path
Path to the template to generate the script to initialize the Puppet
environment that will be part of the userdata
sent to the virtual machine (defaults to "/usr/share/ai-tools/userdata/puppetinit").
.TP
.B --roger-appstate
Initial Roger application state (defaults to "build").
.TP
.B --roger-hostname
FQDN of the Roger instance to use.
.TP
.B --roger-port
Port of the Roger instance to use.
.TP
.B --roger-timeout
Timeout (in seconds) for Roger operations.
.TP
.B --userdata-dir
Directory containing fragments that will be attached to the userdata.
The name of the file will be used to set the Content-Type (see
http://cern.ch/go/C9hm).
.TP
.B -v, --verbose
Be chatty.

.SH EXIT CODES
.TP
.B 0
All operations executed successfully.
.TP
.B 2
Bad command line.
.TP
.B 3
Bad user environment (no OpenStack's openrc.sh has been sourced)
.TP
.B 4
Kerberos TGT not-existent or expired.
.TP
.B 5
FQDN is invalid.
.TP
.B 6
Userdata generation failed.
.TP
.B 10
Foreman registration failed.
.TP
.B 20
Host staging failed.
.TP
.B 30
Nova boot failed.
.TP
.B 40
Cinder volume operation failed.

.SH EXAMPLES
.TP
.B Create a named VM with default VM parameters and register it in hostgroup "foo/bar":
ai-bs-vm --foreman-hostgroup foo/bar --nova-image "SLC6 Server - x86_64 [130920]" higgsbox.cern.ch

.TP
.B Same but with custom environment:
ai-bs-vm -g foo/bar -i "SLC6 Server - x86_64 [130920]" --foreman-environment qa higgsbox.cern.ch

.TP
.B Now with different VM flavor and SSH key:
ai-bs-vm -g foo/bar -i "SLC6 Server - x86_64 [130920]"
--foreman-environment qa --nova-sshkey my-key --nova-flavor m1.large higgsbox.cern.ch

.TP
.B Create a VM with random hostname prefixed by "foo":
ai-bs-vm -g foo/bar -i "SLC6 Server - x86_64 [130920]" --prefix foo

.TP
.B Create a VM booting from an existing volume:
ai-bs-vm -g foo/bar -nova-boot-from-existing-volume 361a5315-aaa2-48dd-990b-235b660eb079

.SH REPORTING BUGS
If you experience any problem with the Foreman registration or the initial
Puppet runs of your box, please open a support call on SNOW (Functional
Element "Configuration Management"). Check the state of your VM with
"nova show" before opening a ticket. If you can see the machine
in Foreman but the VM is in ERROR state then please assign the ticket
directly to "Cloud Infrastructure".

.SH SEE ALSO
ai-kill-vm (1), ai-remote-power-control (1)
